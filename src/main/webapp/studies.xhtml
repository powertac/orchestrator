<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:t="http://myfaces.apache.org/tomahawk"
      xmlns:p="http://primefaces.org/ui">

<h:body>
  <ui:composition template="template.xhtml">
    <ui:define name="content">
      <script type="text/javascript" charset="utf8"
              src="resources/js/studies.js"/>

      <h:form
          rendered="#{user.isResearcher() and actionStudies.studyList.size() > 0}"
          id="runningStudies">
        <br/>

        <h3 class="withButton">Studies</h3>
        <h:button value="Refresh" outcome="studies"/>
        <t:dataTable id="dataStudies" border="1"
                     value="#{actionStudies.studyList}" var="s">

          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:link value="#{s.studyId}" outcome="study">
              <f:param name="studyId" value="#{s.studyId}"/>
            </h:link>
          </t:column>
          <t:column>
            <f:facet name="header">Name</f:facet>
            <h:outputText value="#{s.name}"/>
          </t:column>
          <t:column>
            <f:facet name="header">User</f:facet>
            <h:outputText value="#{s.user.userName}"/>
          </t:column>

          <t:column styleClass="left">
            <f:facet name="header">Actions</f:facet>
            <h:commandButton value="Edit"
                             action="#{actionStudies.editStudy(s)}"
                             rendered="#{s.editingAllowed}"
                             styleClass="actionButton"/>
            <h:commandButton value="Schedule"
                             action="#{actionStudies.scheduleStudy(s)}"
                             rendered="#{s.schedulingAllowed}"
                             styleClass="actionButton"/>
            <h:commandButton value="Pause study"
                             action="#{actionStudies.pauseStudy(s)}"
                             rendered="#{s.pausingAllowed}"
                             styleClass="actionButton"/>
            <h:commandButton value="Delete"
                             action="#{actionStudies.deleteStudy(s)}"
                             rendered="#{s.deletingAllowed}"
                             styleClass="actionButton"
                             onclick="return confirmAlert('Are you sure?\nAll log files will be removed!');"/>
          </t:column>
        </t:dataTable>

        <br/>
      </h:form>

      <h:form id="paramsForm" rendered="#{user.isResearcher()}">
        <h3 class="withButton">Parameters Global</h3>
        <t:dataTable id="paramsGlobal" border="1" styleClass="global_table"
                     value="#{actionStudies.paramsGlobal}" var="a">
          <t:column>
            <f:facet name="header">Key</f:facet>
            <h:outputText value="#{a[0]}"/>
            <sup>
              <h:graphicImage value="resources/images/info.png"
                              style="float: right;"
                              width="20" height="20"
                              rendered="#{a[3] != null}"
                              title="#{a[3]}"/>
            </sup>
          </t:column>
          <t:column>
            <f:facet name="header">Values</f:facet>
            <h:outputText value="#{a[1]}" escape="false"/>
          </t:column>
          <t:column>
            <f:facet name="header">Default</f:facet>
            <h:outputText value="#{a[2]}"/>
          </t:column>
        </t:dataTable>
        <br/>
        <br/>

        <h3 class="withButton">Parameters Server</h3>
        <t:dataTable id="paramsServer" border="1" styleClass="server_table"
                     value="#{actionStudies.paramsServer}" var="a">
          <t:column>
            <f:facet name="header">Key</f:facet>
            <h:outputText value="#{a[0]}"/>
            <sup>
              <h:graphicImage value="resources/images/info.png"
                              style="float: right;"
                              width="20" height="20"
                              rendered="#{a[3] != null}"
                              title="#{a[3]}"/>
            </sup>
          </t:column>
          <t:column>
            <f:facet name="header">Default</f:facet>
            <h:outputText value="#{a[1]}"/>
          </t:column>
        </t:dataTable>
      </h:form>

      <h:form id="saveStudy" rendered="#{user.isResearcher()}">
        <h:panelGroup>
          <h3>
            <h:outputText
                value="#{actionStudies.studyId == -1 ? 'Create' : 'Edit'}"/>
            Studies
          </h3>
        </h:panelGroup>

        <h:panelGroup>
          <h:outputText>
            The list of seed URLs / ids or the multiplier defines the number of experiments<br/>
            Each experiment will be created with the set of variables<br/>
            Variable name is the same as parameters, value format is comma separated values<br/>
            Numeric values can also be min-max,step<br/>
          </h:outputText>
          <br/>
        </h:panelGroup>

        <h:panelGroup>
          <h:outputLabel for="nameInput" value="Study name"
                         styleClass="study_label1"/>
          <h:inputText id="nameInput" styleClass="input_huge"
                       value="#{actionStudies.studyName}"/>
          <br/>
        </h:panelGroup>

        <h:panelGroup>
          <h:outputLabel for="nameInput" value="Select Pom File"
                         styleClass="study_label1"/>
          <h:selectOneMenu id="poms" styleClass="select_wide"
                           value="#{actionStudies.selectedPomId}">
            <f:selectItems value="#{actionStudies.pomList}" var="p"
                           itemValue="#{p.pomId}" itemLabel="#{p.pomName}"/>
            <f:ajax execute="paramsForm" render="paramsForm:paramsServer"/>
          </h:selectOneMenu>
          <br/>
        </h:panelGroup>

        <h:panelGroup>
          <h:outputLabel for="variableName" value="Variable name"
                         styleClass="study_label1"/>
          <h:inputText id="variableName" styleClass="input_huge"
                       value="#{actionStudies.variableName}"/>
          <br/>
        </h:panelGroup>

        <p:outputPanel id="customPanel">
          <p:selectOneRadio id="customRadio" layout="custom"
                            value="#{actionStudies.valuesType}">
            <f:selectItem itemValue="#{actionStudies.radioOptions[0]}"/>
            <f:selectItem itemValue="#{actionStudies.radioOptions[1]}"/>
          </p:selectOneRadio>

          <h:panelGrid columns="3" cellpadding="5">
            <p:radioButton id="opt1" for="customRadio" itemIndex="0"/>
            <h:outputLabel for="opt1" value="comma sep. values"
                           styleClass="study_label2"/>
            <h:inputText styleClass="input_huge"
                         value="#{actionStudies.variableValue}"/>

            <p:radioButton id="opt2" for="customRadio" itemIndex="1"/>
            <h:outputLabel for="opt2" value="min-max,step"
                           styleClass="study_label2"/>
            <h:panelGrid columns="3">
              <h:inputText value="#{actionStudies.variableMin}"
                           styleClass="input_small" style="margin-left: -5px;"/>
              <h:inputText value="#{actionStudies.variableMax}"
                           styleClass="input_small"/>
              <h:inputText value="#{actionStudies.variableStep}"
                           styleClass="input_small"/>
            </h:panelGrid>
          </h:panelGrid>
          <br/>
        </p:outputPanel>

        <h:panelGroup>
          <h:outputLabel for="seedList" styleClass="study_label1" escape="false"
                         value="List of seed URLs or ids&lt;br/&gt;
                         - Overrides multiplier and seedId&lt;br/&gt;
                         - URLs are downloaded during scheduling&lt;br/&gt;
                         - One URL per line"/>
          <h:inputTextarea id="seedList" value="#{actionStudies.seedList}"
                           styleClass="input_huge" rows="5"/>
          <br/>
        </h:panelGroup>

        <h:panelGroup>
          <h:outputText value="Parameters for all experiments / games"/>
          <br/>

          <ui:repeat value="#{actionStudies.paramList}" var="entry">
            <h:panelGroup>
              <h:inputText value="#{entry.name}" styleClass="param_input"/>
              <h:inputText value="#{entry.value}" styleClass="param_input"/>
              <br/>
            </h:panelGroup>
          </ui:repeat>
          <br/>
        </h:panelGroup>

        <h:commandButton
            value="#{actionStudies.studyId == -1 ? 'Create' : 'Update'}"
            action="#{actionStudies.createOrUpdateStudy()}"/>

        <h:inputHidden id="studyId" value="#{actionStudies.studyId}"/>
        <br/>
      </h:form>

      <h:form rendered="#{!user.isResearcher()}">
        <h3>Insufficient Permissions, redirecting in 3 seconds</h3>
        <meta http-equiv="REFRESH" content="3;url=login.xhtml"/>
      </h:form>
    </ui:define>
  </ui:composition>
</h:body>
</html>
