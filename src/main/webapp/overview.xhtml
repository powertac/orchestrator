<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:t="http://myfaces.apache.org/tomahawk">

<h:body>
  <ui:composition template="template.xhtml">
    <ui:define name="content">
      <script type="text/javascript" charset="utf8"
              src="resources/js/overview.js"></script>

      <h:form
          rendered="#{(user.isAdmin()) and (actionOverview.brokerList.size() > 0)}"
          id="brokersForm">
        <br/>

        <h3 class="withButton">Registered Brokers</h3>
        <h:button value="Refresh" outcome="overview"/>
        <h:commandButton id="toggleBrokerViz" value="Hide inactive"
                         onclick="toggleBrokerViz();" type="button"/>

        <t:dataTable id="databrokers" border="1"
                     value="#{actionOverview.brokerList}" var="broker">

          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:outputText value="#{broker.brokerId}" id="id"/>
          </t:column>

          <t:column id="brokerName"
                    styleClass="#{actionOverview.getBrokerState(broker.getBrokerId())}">
            <f:facet name="header">Name</f:facet>
            <h:outputText value="#{broker.brokerName}"/>
            <h:commandButton value="Toggle" styleClass="smallButton float_right"
                             onclick='toggleStateViz("#{broker.getBrokerId()}")'
                             type="button"/>
          </t:column>

          <t:column>
            <f:facet name="header">Games</f:facet>
            <h:outputText
                value="#{actionOverview.getRunningGames(broker.brokerId)}"/>
          </t:column>

          <t:column>
            <f:facet name="header">CheckIns</f:facet>
            <t:outputText id="checkins"/>
          </t:column>

        </t:dataTable>
        <br/>
      </h:form>

      <h:form
          rendered="#{(user.isAdmin()) and (actionOverview.notCompleteExperimentList.size() > 0)}"
          id="experimentForm">

        <h3 class="withButton">Pending/Running Experiments</h3>
        <h:button value="Refresh" outcome="overview"/>

        <t:dataTable id="dataExperiments" border="1"
                     value="#{actionOverview.notCompleteExperimentList}" var="s">

          <t:column>
            <f:facet name="header">ID</f:facet>
            <h:outputText value="#{s.experimentId}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Set name</f:facet>
            <h:outputText value="#{s.study.name}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Status</f:facet>
            <h:outputText value="#{s.state}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Progress</f:facet>
            <h:outputText value="#{s.progress}"/>
          </t:column>
        </t:dataTable>

        <br/>
      </h:form>

      <h:form
          rendered="#{(user.isAdmin()) and (actionOverview.notCompleteGamesList.size() > 0)}"
          id="gamesForm">

        <h3 class="withButton" id="gamesFormHeader">Pending/Running Games</h3>
        <h:button value="Refresh" outcome="overview"/>
        <h:commandButton id="toggleGameViz" value="Hide inactive"
                         onclick="toggleGamesViz();" type="button"/>

        <t:dataTable id="dataGames" border="1"
                     value="#{actionOverview.notCompleteGamesList}" var="g">
          <t:column>
            <f:facet name="header">Name</f:facet>
            <h:outputText value="#{g.gameName}" id="gameId"/>
          </t:column>

          <t:column>
            <f:facet name="header">Status</f:facet>
            <h:outputText value="#{g.state}"/>
          </t:column>

          <t:column>
            <f:facet name="header">Brokers</f:facet>
            <h:outputText value="#{g.getBrokerIdsInGameString()}"
                          style="white-space: nowrap;"/>
          </t:column>

          <t:column styleClass="left">
            <f:facet name="header">Actions</f:facet>
            <h:panelGroup>
              <h:commandButton value="Abort"
                               action="#{actionOverview.abortGame(g)}"
                               onclick="return confirmAlert('Are you sure you want to abort this game?');"
                               rendered="#{g.machine != null and g.state.isRunning()}"
                               styleClass="smallButton"/>
              <h:commandButton value="Kill"
                               action="#{actionOverview.killGame(g)}"
                               onclick="return confirmAlert('Are you sure you want to kill this game?');"
                               rendered="#{g.machine != null}"
                               styleClass="smallButton"/>
              <h:commandButton value="Restart"
                               action="#{actionOverview.restartGame(g)}"
                               rendered="#{g.state.isFailed()}"
                               styleClass="smallButton"/>
            </h:panelGroup>
          </t:column>
        </t:dataTable>

        <br/>
      </h:form>

      <h:form rendered="#{!user.isAdmin()}">
        <h3>Insufficient Permissions, redirecting in 10 seconds</h3>
        <meta http-equiv="REFRESH" content="10;url=login.xhtml"/>
      </h:form>

    </ui:define>
  </ui:composition>
</h:body>
</html>
